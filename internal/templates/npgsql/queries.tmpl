{{define "asyncHeader"}}
        {{- $query := . }}
        await using var connection = conn ?? await dbSource.OpenConnectionAsync();
        await using var command = new NpgsqlCommand({{.ConstantName}}, conn, tx) {
            Parameters = {
                {{- range .Arg.UniqueMembers}}
                {{- if $query.Arg.EmitClass }}
                new NpgsqlParameter<{{.Type}}>() { TypedValue = {{$query.Arg.Name}}.{{.Name}} },
                {{- else}}
                new NpgsqlParameter<{{.Type}}>() { TypedValue = {{.Name}} },
                {{- end}}
                {{- end}}
            }
        }
{{end}}

{{define "syncHeader" }}
        {{- $query := . }}
        using var connection = conn ?? dbSource.OpenConnection();
        using var command = new NpgsqlCommand({{.ConstantName}}, conn, tx) {
            Parameters = {
                {{- range .Arg.UniqueMembers}}
                {{- if $query.Arg.EmitClass }}
                new NpgsqlParameter<{{.Type}}>() { TypedValue = {{$query.Arg.Name}}.{{.Name}} },
                {{- else}}
                new NpgsqlParameter<{{.Type}}>() { TypedValue = {{.Name}} },
                {{- end}}
                {{- end}}
            }
        }
{{end}}

{{define "queriesFile" }}// Code generated by sqlc. DO NOT EDIT.
// versions:
//     sqlc {{ .SqlcVersion }}
//     sqlc-gen-cs {{ .CsGenVersion }}

namespace {{ .Namespace }}

public static class {{ .QueryFileName }} {
    {{range .CodeQueries}}
    {{$query := .}}
    {{if $.OutputQuery .SourceName }}
    const string {{ .ConstantName }} = @"-- name: {{.MethodName}} {{.Cmd}}
    {{.SQL}}
    "

    {{if .Arg.EmitClass}}
    public class {{.Arg.Type}} { {{- range .Arg.UniqueMembers}}
        public {{.Type}} {{.Name}};
        {{- end}}
    }
    {{end}}

    {{if .Ret.EmitClass}}
    public class {{.Ret.Type}} { {{- range .Ret.Class.Members}}
        public {{.Type}} {{.Name}}
        {{- end}}
    }
    {{end}}

    {{if eq .Cmd ":one"}}
    {{range .Comments}}// {{.}}
    {{end}}
    {{- if $.EmitAsync}}
    public static async Task<{{.Ret.Type}}?> {{.MethodName}}(this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "asyncHeader"}}
        await using var reader = command.ExecuteReaderAsync(); 
        if(await reader.ReadAsync()) {
            {{- if .Ret.IsClass}}
            return new {{.Ret.Type}} {
                {{- range $index, $element := .Ret.Class.Members }}
                {{$element.Name}} = reader.GetFieldValue<{{$element.Type}}>({{$index}});
                {{- end}}
            };
            {{- else}}
            return reader.GetFieldValue<{{.Ret.Type}}>(0);
            {{- end}}
        } else {
            return nil;
        } 
    }
    {{- else}}
    public static {{Ret.Type}}? {{.MethodName}} (this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "syncHeader"}}
        using var reader = command.ExecuteReader();
        if(reader.Read()) {
            {{- if .Ret.IsClass}}
            return new {{.Ret.Type}} {
                {{- range $index, $element := .Ret.Class.Members }}
                {{$element.Name}} = reader.GetFieldValue<{{$element.Type}}>({{$index}});
                {{- end}}
            };
            {{- else}}
            return reader.GetFieldValue<{{.Ret.Type}}>(0);
            {{- end}}
        } else {
            return nil;
        } 
    }
    {{- end}}
    {{- end}}

    {{if eq .Cmd ":many"}}
    {{range .Comments}}//{{.}}
    {{end}}
    {{- if $.EmitAsync}}
    public static async Task<List<{{.Ret.Type}}>?> {{.MethodName}}(this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "asyncHeader"}}
        await using var reader = command.ExecuteReaderAsync();
        if(!reader.HasRows()) {
            return null;
        }
        var results = new List<{{.Ret.Type}}>();
        while(await reader.ReadAsync()) {
            {{- if .Ret.IsClass}}
            results.Add(new {{.Ret.Type}} {
                {{- range $index, $element := .Ret.Class.Members }}
                {{$element.Name}} = reader.GetFieldValue<{{$element.Type}}>({{$index}});
                {{- end}}
            });
            {{- else}}
            results.Add(reader.GetFieldValue<{{.Ret.Type}}>(0))
            {{- end}}
        }

        return results
    }
    {{else}}
    public static List<{{Ret.Type}}>? {{.MethodName}} (this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "syncHeader"}}
        using var reader = command.ExecuteReader();
        if(!reader.HasRows()) {
            return null;
        }
        var results = new List<{{.Ret.Type}}>();
        while(reader.ReadAsync()) {
            {{- if .Ret.IsClass}}
            results.Add(new {{.Ret.Type}} {
                {{- range $index, $element := .Ret.Class.Members }}
                {{$element.Name}} = reader.GetFieldValue<{{$element.Type}}>({{$index}});
                {{- end}}
            });
            {{- else}}
            results.Add(reader.GetFieldValue<{{.Ret.Type}}>(0))
            {{- end}}
        }

        return results
    }
    {{- end}}
    {{- end}}

    {{- if eq .Cmd ":exec" ":execresult" ":execrows" }}
    {{range .Comments}}//{{.}}
    {{end}}
    {{- if $.EmitAsync}}
    public static async Task<int> {{.MethodName}}(this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "asyncHeader"}}
        return command.ExecuteNonQueryAsync();
    }
    {{- else}}
    public static int {{.MethodName}} (this NpgsqlDataSource dbSource, NpgsqlConnection? conn = null, NpgsqlTransaction? tx = null, {{.Arg.Pair}}) {
        {{template "syncHeader"}}
        return command.ExecuteNonQuery();
    }
    {{- end}}
    {{- end}}
    {{- end}}
    {{end}}
}
{{end}}